{"version":3,"file":"SanityLiveStream.js","sources":["../../../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js","../../src/client-components/live-stream/SanityLiveStream.tsx"],"sourcesContent":["'use strict';\n\n// do not edit .js files directly - edit src/index.jst\n\n\n\nmodule.exports = function equal(a, b) {\n  if (a === b) return true;\n\n  if (a && b && typeof a == 'object' && typeof b == 'object') {\n    if (a.constructor !== b.constructor) return false;\n\n    var length, i, keys;\n    if (Array.isArray(a)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (!equal(a[i], b[i])) return false;\n      return true;\n    }\n\n\n\n    if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;\n    if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();\n    if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();\n\n    keys = Object.keys(a);\n    length = keys.length;\n    if (length !== Object.keys(b).length) return false;\n\n    for (i = length; i-- !== 0;)\n      if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;\n\n    for (i = length; i-- !== 0;) {\n      var key = keys[i];\n\n      if (!equal(a[key], b[key])) return false;\n    }\n\n    return true;\n  }\n\n  // true if both NaN, false otherwise\n  return a!==a && b!==b;\n};\n","import {\n  type ClientPerspective,\n  type ContentSourceMap,\n  type InitializedClientConfig,\n  type QueryParams,\n} from '@sanity/client'\nimport {stegaEncodeSourceMap} from '@sanity/client/stega'\nimport type {LoaderControllerMsg} from '@sanity/presentation-comlink'\nimport isEqual from 'fast-deep-equal'\nimport {useCallback, useEffect, useState, useSyncExternalStore} from 'react'\nimport * as React from 'react'\nimport {useEffectEvent} from 'use-effect-event'\nimport {comlinkListeners, comlink as comlinkSnapshot} from '../../hooks/context'\n\nconst use: typeof React.use =\n  'use' in React\n    ? // @ts-expect-error this is fine\n      React['u' + 's' + 'e']\n    : () => {\n        throw new TypeError('SanityLiveStream requires a React version with React.use()')\n      }\n\n/**\n * @public\n */\nexport interface SanityLiveStreamProps\n  extends Pick<InitializedClientConfig, 'projectId' | 'dataset'> {\n  query: string\n  params?: QueryParams\n  perspective?: Exclude<ClientPerspective, 'raw'>\n  stega?: boolean\n  initial: Promise<React.ReactNode>\n  children: (result: {\n    data: unknown\n    sourceMap: ContentSourceMap | null\n    tags: string[]\n  }) => Promise<React.ReactNode>\n}\n\nconst LISTEN_HEARTBEAT_INTERVAL = 10_000\n\n/**\n * @public\n */\nexport default function SanityLiveStream(props: SanityLiveStreamProps): React.JSX.Element | null {\n  const {query, dataset, params = {}, perspective, projectId, stega} = props\n\n  const subscribe = useCallback((listener: () => void) => {\n    comlinkListeners.add(listener)\n    return () => comlinkListeners.delete(listener)\n  }, [])\n\n  const comlink = useSyncExternalStore(\n    subscribe,\n    () => comlinkSnapshot,\n    () => null,\n  )\n  const [children, setChildren] = useState<React.ReactNode | undefined>(undefined)\n\n  const handleQueryHeartbeat = useEffectEvent((comlink: NonNullable<typeof comlinkSnapshot>) => {\n    comlink.post('loader/query-listen', {\n      projectId: projectId!,\n      dataset: dataset!,\n      perspective: perspective! as ClientPerspective,\n      query,\n      params: params!,\n      heartbeat: LISTEN_HEARTBEAT_INTERVAL,\n    })\n  })\n  const handleQueryChange = useEffectEvent(\n    (event: Extract<LoaderControllerMsg, {type: 'loader/query-change'}>['data']) => {\n      if (\n        isEqual(\n          {\n            projectId,\n            dataset,\n            query,\n            params,\n          },\n          {\n            projectId: event.projectId,\n            dataset: event.dataset,\n            query: event.query,\n            params: event.params,\n          },\n        )\n      ) {\n        const {result, resultSourceMap, tags} = event\n        const data = stega\n          ? stegaEncodeSourceMap(result, resultSourceMap, {enabled: true, studioUrl: '/'})\n          : result\n        // eslint-disable-next-line no-console\n        // console.log('server function streaming is disabled', {\n        //   startTransition,\n        //   setPromise,\n        //   data,\n        //   resultSourceMap,\n        //   tags,\n        // })\n        // console.log('rendering with server action')\n        // startTransition(() =>\n        //   setPromise(\n        //     props.children({\n        //       data,\n        //       sourceMap: resultSourceMap!,\n        //       tags: tags || [],\n        //     }) as Promise<React.JSX.Element>,\n        //   ),\n        // )\n        // eslint-disable-next-line no-console\n        console.groupCollapsed('rendering with server action')\n        ;(\n          props.children({\n            data,\n            sourceMap: resultSourceMap!,\n            tags: tags || [],\n          }) as Promise<React.JSX.Element>\n        )\n          .then(\n            (children) => {\n              // eslint-disable-next-line no-console\n              console.log('setChildren(children)')\n              // startTransition(() => setChildren(children))\n              setChildren(children)\n            },\n            (reason: unknown) => {\n              // eslint-disable-next-line no-console\n              console.error('rendering with server action: render children error', reason)\n            },\n          )\n          // eslint-disable-next-line no-console\n          .finally(() => console.groupEnd())\n      }\n    },\n  )\n  useEffect(() => {\n    if (!comlink) return\n\n    const unsubscribe = comlink.on('loader/query-change', handleQueryChange)\n    const interval = setInterval(() => handleQueryHeartbeat(comlink), LISTEN_HEARTBEAT_INTERVAL)\n    return () => {\n      clearInterval(interval)\n      unsubscribe()\n    }\n  }, [comlink])\n\n  if (!comlink || children === undefined) {\n    return use(props.initial) as React.JSX.Element\n  }\n\n  return <>{children}</>\n}\nSanityLiveStream.displayName = 'SanityLiveStream'\n"],"names":["comlink","comlinkSnapshot","children"],"mappings":"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","x_google_ignoreList":[0]}